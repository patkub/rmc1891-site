<!--
@license
Copyright (c) 2017 Rogers Manufacturing Company. All rights reserved.
-->

<!-- Polymer -->
<link rel="import" href="../../node_modules/@npm-polymer/polymer/polymer-element.html">

<!-- Template Repeater -->
<link rel="import" href="../../node_modules/@npm-polymer/polymer/lib/elements/dom-repeat.html">

<!-- Iron Ajax -->
<link rel="import" href="../../node_modules/@npm-polymer/iron-ajax/iron-ajax.html">

<dom-module id="view-admin">
  <template>
    
    <!-- container -->
    <div class="container">
    
        <h2>Admin Site</h2>
        
        <template is="dom-if" if="{{!loggedIn}}">
            <form action="javascript:void(0);">
                
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" class="form-control" id="username" placeholder="Username">
                </div>
                
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" class="form-control" id="password" placeholder="Password">
                </div>
                
                <button on-tap="login" name="submit" type="submit" class="btn btn-primary">Login</button>
            </form>
        </template>
        
        <template is="dom-if" if="{{loggedIn}}">
        
            <button on-tap="logout" class="btn btn-primary">Logout</button>
            
            <iron-ajax
                auto
                url="php/feature_cards.php"
                handle-as="json"
                last-response="{{featureCards}}"
            ></iron-ajax>
            
            <form action="php/feature_cards_update.php" method="POST">
                
                <template is="dom-repeat" items="[[featureCards]]">
                    <div class="form-group">
                        <label for="[[item.title]]">[[item.title]]</label>
                        <textarea name$="[[item.title]]Text" class="form-control" rows="5">[[item.text]]</textarea>
                    </div>
                </template>
                
                <button name="submit" type="submit" class="btn btn-primary">Save</button>
            </form>
            
        </template>
        
    </div>
    <!-- /container -->
    
  </template>

  <script>
    /* eslint new-cap: ["error", { "capIsNew": false }] */
    
    class ViewAdmin extends Polymer.GestureEventListeners(Polymer.Element) {
        static get is() {return 'view-admin';}
        static get properties() {
            return {
                loggedIn: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true,
                },
            };
        }
        login(e) {
            // Get form login info
            var user = this.shadowRoot.querySelector('#username').value;
            var pass = this.shadowRoot.querySelector('#password').value;
            
            // Create xhttp request
            var http = new XMLHttpRequest();
            var params = "username=" + user + "&password=" + pass;
            http.open("POST", "php/login.php", true);
            
            // Set header information
            http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
            http.onreadystatechange = function() { // Call a function when the state changes.
                if (http.readyState == 4 && http.status == 200) {
                    // Parse response text as JSON
                    var response = JSON.parse(http.responseText);
                    
                    // Check response status
                    if (response.status === 'success') {
                        // Success!
                        this.loggedIn = true;
                    } else {
                        // Failure
                        this.loggedIn = false;
                    }
                }
            }.bind(this);
            
            // Send the request
            http.send(params);
        }
        logout(e) {
            this.loggedIn = false;
        }
    }
    window.customElements.define(ViewAdmin.is, ViewAdmin);
  </script>
</dom-module>
