<!--
@license
Copyright (c) 2017 Rogers Manufacturing Company. All rights reserved.
-->

<!-- Polymer -->
<link rel="import" href="../../node_modules/@npm-polymer/polymer/polymer-element.html">

<!-- App Location -->
<link rel="import" href="../../node_modules/@npm-polymer/app-route/app-location.html">

<!-- App Route -->
<link rel="import" href="../../node_modules/@npm-polymer/app-route/app-route.html">

<!-- Template Repeater -->
<link rel="import" href="../../node_modules/@npm-polymer/polymer/lib/elements/dom-repeat.html">

<!-- Iron Ajax -->
<link rel="import" href="../../node_modules/@npm-polymer/iron-ajax/iron-ajax.html">

<!-- Iron Pages -->
<link rel="import" href="../../node_modules/@npm-polymer/iron-pages/iron-pages.html">

<!-- Feature Cards -->
<link rel="import" href="../elements/rmc-feature-cards.html">

<!-- Manufacturing Services -->
<link rel="import" href="../elements/rmc-manufacturing-services.html">

<!-- Equipment List -->
<link rel="import" href="../elements/rmc-equipment-list.html">

<!-- Tool Room List -->
<link rel="import" href="../elements/rmc-tool-room/rmc-tool-room-list.html">

<!-- Admin Tabs -->
<link rel="import" href="../elements/rmc-admin-tabs.html">

<!-- Text View -->
<link rel="import" href="../elements/rmc-text-view.html">

<!-- Shared Styles for Views -->
<link rel="import" href="shared-styles-views.html">

<!-- Admin Views -->
<link rel="lazy-import" href="admin/view-admin-home.html">
<link rel="lazy-import" href="admin/view-admin-about.html">
<link rel="lazy-import" href="admin/view-admin-capabilities.html">
<link rel="lazy-import" href="admin/view-admin-contact.html">
<link rel="lazy-import" href="admin/view-admin-404.html">

<!--
`<view-admin>` is the view for the admin page.

In typical use, add the element to an `<iron-pages>` element:

    <iron-pages
        selected="[[page]]"
        attr-for-selected="id"
        role="main">
        
        <view-admin id="admin"></view-admin>
        ...
    </iron-pages>
-->
<dom-module id="view-admin">
  <template>
    <style include="shared-styles-views">
        .btn {
            margin-bottom: 2rem;
        }
    </style>
    
    <!-- container -->
    <div class="container">
    
        <h2>Admin Site</h2>
        
        <template is="dom-if" if="{{!loggedIn}}">
            
            <!-- iron ajax request to login -->
            <iron-ajax
                id="login"
                url="php/login.php"
                content-type="application/x-www-form-urlencoded" 
                handle-as="json"
                method="POST"
                on-response="loginResponse">
            </iron-ajax>
            
            <form action="javascript:void(0);">
                
                <div class="form-group">
                    <label for="username">Username:</label>
                    <input type="text" class="form-control" id="username" placeholder="Username">
                </div>
                
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" class="form-control" id="password" placeholder="Password">
                </div>
                
                <button on-tap="login" name="submit" type="submit" class="btn btn-primary">Login</button>
            </form>
        </template>
        
        <template is="dom-if" if="{{loggedIn}}">
            <button on-tap="logout" class="btn btn-primary">Logout</button>
            
            <app-location route="{{route}}"></app-location>
            <app-route route="{{route}}" pattern="/:page" data="{{routeData}}"></app-route>
            
            <!-- navigation tabs -->
            <rmc-admin-tabs active="{{page}}"></rmc-admin-tabs>
            
            <iron-pages
                selected="{{page}}"
                attr-for-selected="id"
                fallback-selection="404"
                class="pages">
                
                <view-admin-home id="home"></view-admin-home>
                <view-admin-about id="about"></view-admin-about>
                <view-admin-capabilities id="capabilities"></view-admin-capabilities>
                <view-admin-contact id="contact"></view-admin-contact>
                <view-admin-404 id="404"></view-admin-404>
            </iron-pages>
        </template>
        
    </div>
    <!-- /container -->
    
  </template>

  <script>
    /* eslint new-cap: ["error", { "capIsNew": false }] */
    class ViewAdmin extends Polymer.GestureEventListeners(Polymer.Element) {
        static get is() {
            return 'view-admin';
        }
        
        static get properties() {
            return {
                loggedIn: {
                    type: Boolean,
                    value: false,
                    reflectToAttribute: true,
                },
                page: {
                    type: String,
                    reflectToAttribute: true,
                },
                routeData: Object,
            };
        }
        
        static get observers() {
            return [
              '_routePageChanged(routeData.page)',
            ];
        }
        
        _routePageChanged(page) {
            // Polymer 2.0 will call with `undefined` on initialization.
            // Ignore until we are properly called with a string.
            if (page === undefined) {
              return;
            }
            // If no page was found in the route data, page will be an empty string.
            // Default to 'home' in that case.
            this.page = page || 'home';
        
            // Scroll to top of page
            window.scrollTo(0, 0);
        }
        
        _pageChanged(page) {
            // Load page import on demand. Show 404 page if fails
            let resolvedPageUrl = this.resolveUrl('admin/view-admin-' + page + '.html');
            Polymer.importHref(
                resolvedPageUrl,
                null,
                this._showPage404.bind(this),
                true);
        }
        
        _showPage404() {
            this.page = '404';
        }
      
        login(e) {
            // Get form login info
            let user = this.shadowRoot.querySelector('#username').value;
            let pass = this.shadowRoot.querySelector('#password').value;
            
            // login
            let params = 'username=' + user + '&password=' + pass;
            let xhr = this.shadowRoot.getElementById('login');
            xhr.body = params;
            xhr.generateRequest();
        }
        loginResponse(e) {
            // Get response
            let response = e.detail.response;
            
            // Check response status
            if (response.status === 'success') {
                // Success!
                this.loggedIn = true;
            } else {
                // Failure
                this.loggedIn = false;
            }
        }
        logout(e) {
            this.loggedIn = false;
        }
        changePage(e) {
            this.page = e.target.dataset.args;
            e.preventDefault();
        }
    }
    window.customElements.define(ViewAdmin.is, ViewAdmin);
  </script>
</dom-module>
